'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.default=webhook;var _scheduleJs=require('schedule-js');var _scheduleJs2=_interopRequireDefault(_scheduleJs);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function webhook(config){var http=require('http'),createHandler=require('github-webhook-handler'),handler=config.github?createHandler({path:config.github.path,secret:config.github.secret}):false,spawn=require('child_process').spawn,slack=config.slack?require('slack-notify')(config.slack.url):false;http.createServer(function(req,res){handler(req,res,function(err){res.statusCode=404;res.end('no such location');});}).listen(config.port);handler.on('error',function(err){return console.error('Error: '+err.message);});var gitPull=function gitPull(event){var gitReset=spawn('git',['reset','--hard'],{cwd:config.github.projectRoot});gitReset.on('exit',function(code){var gitProcess=spawn('git',['pull'],{cwd:config.github.projectRoot});console.log('on exit');gitProcess.stdout.pipe(process.stdout);gitProcess.stderr.pipe(process.stderr);if(event){gitProcess.on('exit',function(code){slack.send({channel:'#'+config.slack.channel,text:config.slack.projectName+', pointing at '+event.payload.ref+' has been updated',unfurl_links:1,username:'webhook',fields:{'Commit':event.payload.head_commit.id,'Message':event.payload.head_commit.message,'Author':event.payload.head_commit.author.name}});if(config.hasOwnProperty('exec')){var exec=require('child_process').exec;exec(config.exec,function(error,stdout,stderr){console.log('stdout: '+stdout);console.log('stderr: '+stderr);if(error!==null){console.log('exec error: '+error);}});}});}else{gitProcess.on('exit',function(code){slack.send({channel:'#'+config.slack.channel,text:config.slack.projectName+', scheduled "git pull"',unfurl_links:1,username:'webhook'});if(config.hasOwnProperty('exec')){var exec=require('child_process').exec;if(typeof config.exec==='string'){exec(config.exec,function(error,stdout,stderr){console.log('stdout: '+stdout);console.log('stderr: '+stderr);if(error!==null){console.log('exec error: '+error);}});}else if(config.exec[0]){var execCommand='';config.exec.forEach(function(command,idx){if(idx===config.exec.length-1){execCommand+=command;}else{execCommand+=command+' && ';}});exec(execCommand,function(error,stdout,stderr){console.log('stdout: '+stdout);console.log('stderr: '+stderr);if(error!==null){console.log('exec error: '+error);}});}}});}});};handler.on('push',function(event){return gitPull(event);});if(config.hasOwnProperty('schedule')){_scheduleJs2.default.scheduleAt(config.schedule[0],config.schedule[1],gitPull);}}